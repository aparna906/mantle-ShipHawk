<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-2.1.xsd">
    <service verb="find" noun="Order">
        <in-parameters>
            <parameter name="statusId"/>
        </in-parameters>
        <out-parameters>
            <parameter name="responseMap"/>
        </out-parameters>
        <actions>
            <service-call name="co.hotwax.oms.OrderServices.find#Orders" in-map="[statusId:statusId]" out-map="orderOut"/>
            <log message="====orderOut===${orderOut}===="/>
            <iterate list="orderOut.orders" entry="order">
                <log message="====order====${order}===="/>
                <set field="order_number" from="order.orderId"/>
                <log message="===============order_number:${order_number}============="/>
          <!-- Origin Address-->
                <service-call name="co.hotwax.oms.FacilityServices.find#Facilities" out-map="facilityOut"/>
                <log message="==========facility:${facilityOut}================"/>
                <iterate list="facilityOut.facilities" entry="facility">
                  <set field="origin_address" from="[name:facility.locationName,street1:facility.stateProvinceGeoId,
                                                     city:facility.city,zip:facility.postalCode]"/>
                  <log message="===============origin_address:${origin_address}============="/>
                </iterate>
                <set field="requestMap" from="[order_number:order_number,origin_address:origin_address]"/>
                <log message="==============requestMap======${requestMap}========"/>
                <script>
                <![CDATA[
                org.moqui.util.RestClient
                restClient = ec.service.rest().method(org.moqui.util.RestClient.POST)
                        .addHeader("Content-Type", "application/json").jsonObject(requestMap)
                restClient.uri().protocol("https").host("sandbox.shiphawk.com")
// TO DO Remove the hardcoded api key as it is not recommended to store any credentials in the public repo
                port(443).path("/api/v4/orders?api_key=03341427e3d29f6cb89c04749136a811").build()
                org.moqui.util.RestClient.RestResponse restResponse = restClient.call()
                if (restResponse.statusCode < 200 || restResponse.statusCode >= 300) {
                    String errMsg = restResponse.text()
                    ec.logger.error("error response (${restResponse.statusCode}): ${errMsg}")
                    ec.message.addMessage("API error")
                    ec.message.addMessage(errMsg)
                    return
                }
                responseMap = restResponse.jsonObject()
                println(responseMap);
                ]]>
            </script>
            </iterate>
        </actions>
    </service>
</services>





















